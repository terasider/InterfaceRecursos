<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Editor de Checklist</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    ul {
      list-style: none;
      padding-left: 0;
      margin-left: 0;
    }
    li {
      margin-bottom: 5px;
      position: relative;
      padding-left: 20px; /* espa√ßo para linha vertical */
    }
    /* Linha vertical conectando os subitens */
    ul ul {
      border-left: 2px solid #aaa;
      margin-left: 10px;
      padding-left: 10px;
    }

    .item {
      display: flex;
      align-items: center;
      gap: 5px;
      position: relative;
      cursor: default;
      background-color: white;
      padding: 3px 6px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    /* √çcone expandir/colapsar */
    .toggle-btn {
      width: 16px;
      user-select: none;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #333;
      font-weight: bold;
    }
    .toggle-btn.empty {
      visibility: hidden; /* esconde √≠cone se n√£o tem filhos */
    }

    .item input[type="text"] {
      flex-grow: 1;
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 4px 6px;
      font-size: 14px;
    }

    .item input[type="text"]:focus {
      outline: none;
      border-color: #0066ff;
      box-shadow: 0 0 4px #66aaff;
      background-color: #e7f0ff;
    }

    button {
      margin-left: 5px;
      font-size: 14px;
      cursor: pointer;
      background-color: #eee;
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 2px 6px;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #ddd;
    }

    .controls {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h1>Editor de Checklist</h1>
  <div id="checklistContainer"></div>
  <div class="controls">
    <button onclick="exportJSON()">Exportar JSON</button>
    <input type="file" accept=".json" onchange="importJSON(event)">
  </div>

  <script>
function mostrarAtalhos() {
  alert(`üß† Atalhos de Teclado Dispon√≠veis, anote:

üîÅ Navega√ß√£o entre itens:
  ‚Üë  - Ir para o item anterior
  ‚Üì  - Ir para o pr√≥ximo item

‚å®Ô∏è Cria√ß√£o e edi√ß√£o com Ctrl:
  Ctrl + ‚Üë  - Novo item raiz
  Ctrl + ‚Üí  - Novo item abaixo (mesmo n√≠vel)
  Ctrl + ‚Üì  - Novo subitem
  Ctrl + ‚Üê  - Excluir item atual

üîÑ Desfazer e Refazer:
  Ctrl + Z  - Desfazer a√ß√£o
  Ctrl + Y  - Refazer a√ß√£o

üß≠ Outros:
  Ctrl + Backspace  - Focar no √∫ltimo item da lista
`);
}


    // Fun√ß√£o para gerar IDs √∫nicas
    function generateId() {
      return '_' + Math.random().toString(36).substr(2, 9);
    }

    // Dados do checklist, cada item tem id, text, children[] e expanded
    let checklistData = [];

    // Pilhas para hist√≥rico de undo/redo
    let undoStack = [];
    let redoStack = [];

    // Estado para armazenar qual item est√° focado
    let lastFocusedItemId = null;

    // Clona profundamente o checklist para hist√≥rico
    function cloneChecklist(data) {
      return JSON.parse(JSON.stringify(data));
    }

    // Salva o estado atual para desfazer (undo)
    function saveStateForUndo() {
      undoStack.push(cloneChecklist(checklistData));
      redoStack = [];
    }

    // Fun√ß√£o desfazer (undo)
    function undo() {
      if (undoStack.length === 0) return;
      redoStack.push(cloneChecklist(checklistData));
      checklistData = undoStack.pop();
      renderChecklist(() => {
        if(lastFocusedItemId) focusItem(lastFocusedItemId);
      });
    }

    // Fun√ß√£o refazer (redo)
    function redo() {
      if (redoStack.length === 0) return;
      undoStack.push(cloneChecklist(checklistData));
      checklistData = redoStack.pop();
      renderChecklist(() => {
        if(lastFocusedItemId) focusItem(lastFocusedItemId);
      });
    }

    // Captura globalmente Ctrl+Z e Ctrl+Y para undo/redo
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && !e.shiftKey && e.key.toLowerCase() === 'z') {
        e.preventDefault();
        undo();
      } else if (e.ctrlKey && e.key.toLowerCase() === 'y') {
        e.preventDefault();
        redo();
      }
      // Ctrl + Backspace para focar no √∫ltimo item criado
      else if (e.ctrlKey && e.key === "Backspace") {
        e.preventDefault();
        if (checklistData.length === 0) return;
        // Encontrar √∫ltimo item do checklist (√∫ltimo item recursivo)
        const last = findLastItem(checklistData);
        if(last) focusItem(last.id);
      }
    });

    // Encontra √∫ltimo item em ordem recursiva (√∫ltimo subitem do √∫ltimo item)
    function findLastItem(data) {
      if (!data.length) return null;
      const last = data[data.length - 1];
      if (last.children && last.children.length > 0) {
        return findLastItem(last.children);
      }
      return last;
    }

    // Foca no input que tem data-item-id = targetId
    function focusItem(targetId) {
      lastFocusedItemId = targetId;
      setTimeout(() => {
        const inputs = document.querySelectorAll('.checklist-item');
        for (const input of inputs) {
          if (input.dataset.itemId === targetId) {
            input.focus();
            break;
          }
        }
      }, 0);
    }

    // Fun√ß√£o para focar no item anterior ou pr√≥ximo ap√≥s exclus√£o
    function focusBeforeDeletedItem(deletedItemId) {
      setTimeout(() => {
        const inputs = Array.from(document.querySelectorAll('.checklist-item'));
        // Encontra √≠ndice do item deletado no DOM
        const idx = inputs.findIndex(input => input.dataset.itemId === deletedItemId);
        if (idx === -1) return;
        if (idx > 0) inputs[idx - 1].focus();
        else if (inputs.length > 0) inputs[0].focus();
      }, 0);
    }

    // Fun√ß√£o para mover foco para o pr√≥ximo ou anterior input
    function focusMove(direction) {
      const inputs = Array.from(document.querySelectorAll('.checklist-item'));
      const active = document.activeElement;
      const idx = inputs.findIndex(i => i === active);
      if (idx === -1) return;

      if (direction === 'up' && idx > 0) {
        inputs[idx - 1].focus();
      } else if (direction === 'down' && idx < inputs.length - 1) {
        inputs[idx + 1].focus();
      }
    }

    // Fun√ß√£o para expandir ou colapsar item pelo ID
    function toggleExpandItemById(id, data = checklistData) {
      for (const item of data) {
        if (item.id === id) {
          item.expanded = !item.expanded;
          return true;
        }
        if (item.children && toggleExpandItemById(id, item.children)) {
          return true;
        }
      }
      return false;
    }

    // Cria a √°rvore recursivamente e adiciona no container
    function createChecklist(container, data, parent = null) {
      const ul = document.createElement('ul');

      data.forEach((item, index) => {
        const li = document.createElement('li');
        const div = document.createElement('div');
        div.className = 'item';

        // √çcone expandir/colapsar
        const toggleBtn = document.createElement('span');
        toggleBtn.className = 'toggle-btn';
        if (!item.children || item.children.length === 0) {
          toggleBtn.classList.add('empty');
          toggleBtn.textContent = ''; // sem √≠cone se n√£o tem filhos
        } else {
          toggleBtn.textContent = item.expanded ? '‚ñº' : '‚ñ∂';
          toggleBtn.title = item.expanded ? 'Colapsar' : 'Expandir';
          toggleBtn.onclick = () => {
            saveStateForUndo();
            item.expanded = !item.expanded;
            renderChecklist(() => focusItem(item.id));
          };
        }

        const input = document.createElement('input');
        input.type = 'text';
        input.value = item.text || '';
        input.classList.add('checklist-item'); // Classe exclusiva para facilitar sele√ß√£o
        input.dataset.itemId = item.id;

        input.oninput = () => { item.text = input.value; };

        // Salvar foco atual no input
        input.onfocus = () => { lastFocusedItemId = item.id; };

        // Atalhos de teclado (Ctrl + setas e setas simples para navega√ß√£o)
        input.addEventListener('keydown', (e) => {
          // Navega√ß√£o comum (sem ctrl)
          if (!e.ctrlKey) {
            if (e.key === 'ArrowUp') {
              e.preventDefault();
              focusMove('up');
              return;
            }
            else if (e.key === 'ArrowDown') {
              e.preventDefault();
              focusMove('down');
              return;
            }
          }

          if (!e.ctrlKey) return;

          if (e.key === 'ArrowRight') {
            e.preventDefault();
            saveStateForUndo();
            const newItem = { id: generateId(), text: '', children: [], expanded: true };
            data.splice(index + 1, 0, newItem);
            renderChecklist(() => focusItem(newItem.id));
          }
          else if (e.key === 'ArrowDown') {
            e.preventDefault();
            saveStateForUndo();
            item.children = item.children || [];
            const newChild = { id: generateId(), text: '', children: [], expanded: true };
            item.children.push(newChild);
            item.expanded = true;
            renderChecklist(() => focusItem(newChild.id));
          }
          else if (e.key === 'ArrowUp') {
            e.preventDefault();
            saveStateForUndo();
            const newRoot = { id: generateId(), text: '', children: [], expanded: true };
            checklistData.push(newRoot);
            renderChecklist(() => focusItem(newRoot.id));
          }
          else if (e.key === 'ArrowLeft') {
            e.preventDefault();
            saveStateForUndo();

            // Fun√ß√£o para remover item do array pai
            function removeItemFromData(itemToRemove, dataList) {
              const idx = dataList.indexOf(itemToRemove);
              if (idx > -1) {
                dataList.splice(idx, 1);
                return true;
              }
              for (const item of dataList) {
                if (item.children && removeItemFromData(itemToRemove, item.children)) {
                  return true;
                }
              }
              return false;
            }

            const deletedItemId = item.id;
            removeItemFromData(item, checklistData);
            renderChecklist(() => focusBeforeDeletedItem(deletedItemId));
          }
        });

        // Bot√£o para adicionar subitem manualmente
        const addBtn = document.createElement('button');
        addBtn.textContent = '+ Subitem';
        addBtn.onclick = () => {
          saveStateForUndo();
          item.children = item.children || [];
          const newChild = { id: generateId(), text: '', children: [], expanded: true };
          item.children.push(newChild);
          item.expanded = true;
          renderChecklist(() => focusItem(newChild.id));
        };

        // Bot√£o para deletar o item
        const delBtn = document.createElement('button');
        delBtn.textContent = 'üóëÔ∏è';
        delBtn.onclick = () => {
          saveStateForUndo();
          const idx = data.indexOf(item);
          if (idx > -1) data.splice(idx, 1);
          renderChecklist(() => {
            // focar pr√≥ximo ou anterior ao deletar
            focusBeforeDeletedItem(item.id);
          });
        };

        div.appendChild(toggleBtn);
        div.appendChild(input);
        div.appendChild(addBtn);
        div.appendChild(delBtn);
        li.appendChild(div);

        if (item.children && item.children.length > 0 && item.expanded) {
          const childUl = createChecklist(li, item.children, item);
          li.appendChild(childUl);
        }

        ul.appendChild(li);
      });

      container.appendChild(ul);
      return ul;
    }

    // Renderiza todo checklist e opcionalmente executa callback p√≥s render
    function renderChecklist(callbackAfterRender) {
      const container = document.getElementById('checklistContainer');
      container.innerHTML = '';
      createChecklist(container, checklistData);

      const addRootBtn = document.createElement('button');
      addRootBtn.textContent = '+ Adicionar Item Raiz';
      addRootBtn.onclick = () => {
        saveStateForUndo();
        const newItem = { id: generateId(), text: '', children: [], expanded: true };
        checklistData.push(newItem);
        renderChecklist(() => focusItem(newItem.id));
      };
      container.appendChild(addRootBtn);

      if (callbackAfterRender) callbackAfterRender();
    }

    // Exporta checklist para JSON e baixa arquivo
    function exportJSON() {
      const dataStr = JSON.stringify(checklistData, null, 2);
      const blob = new Blob([dataStr], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "checklist.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    // Importa checklist a partir de arquivo JSON
    function importJSON(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const imported = JSON.parse(e.target.result);
          if (Array.isArray(imported)) {
            saveStateForUndo();
            checklistData = imported;
            renderChecklist();
          } else {
            alert("Arquivo JSON inv√°lido!");
          }
        } catch (error) {
          alert("Erro ao ler JSON: " + error.message);
        }
      };
      reader.readAsText(file);
    }

    // Inicializa checklist vazio e renderiza
    checklistData = [
      {
        id: generateId(),
        text: 'Item Exemplo 1',
        children: [
          { id: generateId(), text: 'Subitem 1.1', children: [], expanded: true },
          { id: generateId(), text: 'Subitem 1.2', children: [], expanded: true }
        ],
        expanded: true
      },
      {
        id: generateId(),
        text: 'Item Exemplo 2',
        children: [],
        expanded: true
      }
    ];
    renderChecklist();

  </script>
</body>
</html>

